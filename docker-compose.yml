version: '3.8'

services:
  # =========================================
  # Frontend
  # Host: 8080 -> Container: 80
  # =========================================
  frontend:
    build:
      context: ./frontend # ./frontendがルートになる
      dockerfile: Dockerfile.dev # /Dockerfile.dev を見る
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "8080:80"  # 図の指定通り
    environment:
      # ブラウザがアクセスするBFFのURL (ホスト側ポート)
      - NEXT_PUBLIC_API_URL=http://localhost:8081/api/v1
      - PORT=80    # Next.js/Vite等にポート80で起動するよう指示
    stdin_open: true
    tty: true

#   # =========================================
#   # BFF
#   # Host: 8081 -> Container: 80
#   # =========================================
#   bff:
#     build:
#       context: ./bff
#       dockerfile: Dockerfile.dev
#     volumes:
#       - ./bff:/app
#     ports:
#       - "8081:80"
#     environment:
#       # コンテナ間通信なので、相手のサービス名とポート80を指定
#       - USER_SERVICE_URL=http://user-service:80
#       - QUIZ_SERVICE_URL=http://quiz-service:80
#       - PROGRESS_SERVICE_URL=http://progress-service:80
#       - GENERATOR_SERVICE_URL=http://generator-service:80
#       - EXECUTOR_SERVICE_URL=http://executor-service:80
#       - VALIDATOR_SERVICE_URL=http://validator-service:80
#       - TUTOR_SERVICE_URL=http://tutor-service:80
#     command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "80", "--reload"]

#   # =========================================
#   # Microservices (Domain)
#   # =========================================
  
#   # User Service (Host: 8082 -> Container: 80)
#   user-service:
#     build:
#       context: ./user-service
#       dockerfile: Dockerfile.dev
#     volumes:
#       - ./user-service:/app
#     ports:
#       - "8082:80"
#     environment:
#       - DATABASE_URL=postgresql://user:password@user-db:5432/user_db
#     depends_on:
#       - user-db
#     command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "80", "--reload"]

#   # Quiz Service (Host: 8083 -> Container: 80)
#   quiz-service:
#     build:
#       context: ./quiz-service
#       dockerfile: Dockerfile.dev
#     volumes:
#       - ./quiz-service:/app
#     ports:
#       - "8083:80"
#     environment:
#       - DATABASE_URL=postgresql://user:password@quiz-db:5432/quiz_db
#     depends_on:
#       - quiz-db
#     command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "80", "--reload"]

#   # Progress Service (Host: 8084 -> Container: 80)
#   progress-service:
#     build:
#       context: ./progress-service
#       dockerfile: Dockerfile.dev
#     volumes:
#       - ./progress-service:/app
#     ports:
#       - "8084:80"
#     environment:
#       - DATABASE_URL=postgresql://user:password@progress-db:5432/progress_db
#     depends_on:
#       - progress-db
#     command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "80", "--reload"]

#   # =========================================
#   # Microservices (Function)
#   # =========================================

#   # Generator Service (Host: 8085 -> Container: 80)
#   generator-service:
#     build:
#       context: ./generator-service
#       dockerfile: Dockerfile.dev
#     volumes:
#       - ./generator-service:/app
#     ports:
#       - "8085:80"
#     environment:
#       - OPENAI_API_KEY=${OPENAI_API_KEY}
#     command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "80", "--reload"]

#   # Executor Service (Host: 8086 -> Container: 80)
#   executor-service:
#     build:
#       context: ./executor-service
#       dockerfile: Dockerfile.dev
#     volumes:
#       - ./executor-service:/app
#       - /var/run/docker.sock:/var/run/docker.sock
#     ports:
#       - "8086:80"
#     command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "80", "--reload"]

#   # Validator Service (Host: 8087 -> Container: 80)
#   validator-service:
#     build:
#       context: ./validator-service
#       dockerfile: Dockerfile.dev
#     volumes:
#       - ./validator-service:/app
#     ports:
#       - "8087:80"
#     command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "80", "--reload"]

#   # Tutor Service (Host: 8089 -> Container: 80)
#   tutor-service:
#     build:
#       context: ./tutor-service
#       dockerfile: Dockerfile.dev
#     volumes:
#       - ./tutor-service:/app
#     ports:
#       - "8089:80"
#     command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "80", "--reload"]

#   # =========================================
#   # Databases
#   # =========================================
  
#   # User DB (Host: 5501 -> Container: 5432)
#   user-db:
#     image: postgres:15-alpine
#     volumes:
#       - user_db_data:/var/lib/postgresql/data
#     environment:
#       - POSTGRES_USER=user
#       - POSTGRES_PASSWORD=password
#       - POSTGRES_DB=user_db
#     ports:
#       - "5501:5432"

#   # Quiz DB (Host: 5502 -> Container: 5432)
#   quiz-db:
#     image: postgres:15-alpine
#     volumes:
#       - quiz_db_data:/var/lib/postgresql/data
#     environment:
#       - POSTGRES_USER=user
#       - POSTGRES_PASSWORD=password
#       - POSTGRES_DB=quiz_db
#     ports:
#       - "5502:5432"

#   # Progress DB (Host: 5503 -> Container: 5432)
#   progress-db:
#     image: postgres:15-alpine
#     volumes:
#       - progress_db_data:/var/lib/postgresql/data
#     environment:
#       - POSTGRES_USER=user
#       - POSTGRES_PASSWORD=password
#       - POSTGRES_DB=progress_db
#     ports:
#       - "5503:5432"

# volumes:
#   user_db_data:
#   quiz_db_data:
#   progress_db_data: